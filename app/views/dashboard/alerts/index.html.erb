<div class="space-y-6" data-controller="export">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-[24px] font-semibold tracking-tight dm-text">Alerts</h1>
      <p class="text-[14px] mt-1 dm-text-muted">Monitor and manage active alerts across your project</p>
    </div>
    <button data-action="export#open" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-[13px] font-medium transition-all dm-btn-secondary">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
      Export
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-3 gap-4">
    <div class="rounded-2xl px-5 py-5 shadow-card transition-all hover:shadow-medium dm-border" style="background: var(--gradient-card-error);">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-error">
          <svg class="w-5 h-5 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wider dm-text-muted">Firing</p>
          <p class="text-[28px] font-bold leading-none mt-1 text-error"><%= @firing_count %></p>
        </div>
      </div>
    </div>
    <div class="rounded-2xl px-5 py-5 shadow-card transition-all hover:shadow-medium dm-border" style="background: var(--gradient-card-warning);">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-warning">
          <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wider dm-text-muted">Pending</p>
          <p class="text-[28px] font-bold leading-none mt-1 text-warning"><%= @pending_count %></p>
        </div>
      </div>
    </div>
    <div class="rounded-2xl px-5 py-5 shadow-card transition-all hover:shadow-medium dm-border" style="background: var(--gradient-card-success);">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-success">
          <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wider dm-text-muted">Resolved Today</p>
          <p class="text-[28px] font-bold leading-none mt-1 text-success"><%= @resolved_today %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search + Filters -->
  <div class="rounded-2xl p-4 shadow-card dm-card dm-border space-y-3">
    <form method="get" action="<%= dashboard_project_alerts_path(@project) %>" class="flex flex-wrap items-center gap-3">
      <!-- Text search -->
      <div class="flex-1 min-w-[200px]">
        <input type="text" name="q" value="<%= params[:q] %>" placeholder="Search rules or labels..."
               class="w-full px-3 py-2 rounded-lg text-[13px] dm-input dm-border" />
      </div>

      <!-- Source filter -->
      <select name="source" class="px-3 py-2 rounded-lg text-[13px] dm-input dm-border">
        <option value="">All Sources</option>
        <% %w[flux pulse reflex recall].each do |src| %>
          <option value="<%= src %>" <%= 'selected' if params[:source] == src %>><%= src.capitalize %></option>
        <% end %>
      </select>

      <!-- Severity filter -->
      <select name="severity" class="px-3 py-2 rounded-lg text-[13px] dm-input dm-border">
        <option value="">All Severities</option>
        <% %w[critical warning info].each do |sev| %>
          <option value="<%= sev %>" <%= 'selected' if params[:severity] == sev %>><%= sev.capitalize %></option>
        <% end %>
      </select>

      <!-- Sort -->
      <select name="sort" class="px-3 py-2 rounded-lg text-[13px] dm-input dm-border">
        <option value="">Newest First</option>
        <option value="oldest" <%= 'selected' if params[:sort] == 'oldest' %>>Oldest First</option>
        <option value="severity" <%= 'selected' if params[:sort] == 'severity' %>>By Severity</option>
        <option value="duration" <%= 'selected' if params[:sort] == 'duration' %>>By Duration</option>
      </select>

      <button type="submit" class="px-4 py-2 rounded-lg text-[13px] font-medium text-white transition-all hover:opacity-90" style="background: var(--color-signal);">Search</button>

      <% if params[:q].present? || params[:source].present? || params[:severity].present? || params[:sort].present? %>
        <%= link_to "Clear", dashboard_project_alerts_path(@project), class: "px-3 py-2 text-[13px] dm-text-muted hover:dm-text transition-colors" %>
      <% end %>
    </form>

    <!-- Saved Searches -->
    <% if @saved_searches&.any? %>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-[11px] font-semibold uppercase tracking-wider dm-text-muted">Saved:</span>
        <% @saved_searches.each do |ss| %>
          <div class="inline-flex items-center gap-1">
            <%= link_to ss.name,
              dashboard_project_alerts_path(@project, ss.query_params),
              class: "px-2.5 py-1 rounded-full text-[11px] font-medium dm-badge-info transition-all hover:opacity-80" %>
            <%= button_to dashboard_project_saved_search_path(@project, ss),
              method: :delete,
              class: "text-[10px] dm-text-muted hover:text-error transition-colors",
              data: { turbo_confirm: "Delete this saved search?" } do %>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Save current search -->
    <% if params[:q].present? || params[:state].present? || params[:severity].present? || params[:source].present? %>
      <details class="text-[12px]">
        <summary class="cursor-pointer dm-text-muted hover:dm-text transition-colors">Save this search</summary>
        <%= form_with url: dashboard_project_saved_searches_path(@project), method: :post, class: "flex items-center gap-2 mt-2" do |f| %>
          <input type="text" name="saved_search[name]" placeholder="Search name..." required
                 class="px-3 py-1.5 rounded-lg text-[12px] dm-input dm-border w-48" />
          <% %w[q state severity source sort since until].each do |key| %>
            <% if params[key].present? %>
              <input type="hidden" name="saved_search[query_params][<%= key %>]" value="<%= params[key] %>" />
            <% end %>
          <% end %>
          <button type="submit" class="px-3 py-1.5 rounded-lg text-[12px] font-medium text-white" style="background: var(--color-signal);">Save</button>
        <% end %>
      </details>
    <% end %>
  </div>

  <!-- State Filters -->
  <div class="flex items-center gap-2 p-1 rounded-xl w-fit" style="background: var(--color-border-subtle);">
    <%= link_to "All", dashboard_project_alerts_path(@project, request.query_parameters.except("state")), class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-all #{params[:state].blank? ? 'shadow-sm dm-card dm-text' : 'dm-text-placeholder hover:bg-surface-hover'}" %>
    <%= link_to "Firing", dashboard_project_alerts_path(@project, request.query_parameters.merge(state: 'firing')), class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-all #{params[:state] == 'firing' ? 'shadow-sm dm-card text-error' : 'dm-text-placeholder hover:bg-surface-hover'}" %>
    <%= link_to "Pending", dashboard_project_alerts_path(@project, request.query_parameters.merge(state: 'pending')), class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-all #{params[:state] == 'pending' ? 'shadow-sm dm-card text-warning' : 'dm-text-placeholder hover:bg-surface-hover'}" %>
    <%= link_to "Resolved", dashboard_project_alerts_path(@project, request.query_parameters.merge(state: 'resolved')), class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-all #{params[:state] == 'resolved' ? 'shadow-sm dm-card text-success' : 'dm-text-placeholder hover:bg-surface-hover'}" %>
  </div>

  <!-- Alerts List -->
  <% if @alerts.any? %>
    <div class="rounded-2xl overflow-hidden shadow-card dm-card">
      <% @alerts.each_with_index do |alert, index| %>
        <%= link_to dashboard_project_alert_path(@project, alert), class: "block px-5 py-4 transition-all dm-surface-hover group #{index > 0 ? 'border-t dm-border-light' : ''}" do %>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <!-- State indicator -->
              <% case alert.state %>
              <% when 'firing' %>
                <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-error">
                  <span class="w-3 h-3 rounded-full animate-pulse" style="background: var(--color-error-dot);"></span>
                </div>
              <% when 'pending' %>
                <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-warning">
                  <span class="w-3 h-3 rounded-full" style="background: var(--color-warning-dot);"></span>
                </div>
              <% else %>
                <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-success">
                  <span class="w-3 h-3 rounded-full" style="background: var(--color-success-dot);"></span>
                </div>
              <% end %>

              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-[14px] font-medium group-hover:text-signal transition-colors dm-text"><%= alert.alert_rule&.name || 'Unknown Rule' %></h3>
                  <!-- Severity badge -->
                  <% case alert.alert_rule&.severity %>
                  <% when 'critical' %>
                    <span class="px-2 py-0.5 text-[10px] font-semibold uppercase rounded-full dm-badge-error">Critical</span>
                  <% when 'warning' %>
                    <span class="px-2 py-0.5 text-[10px] font-semibold uppercase rounded-full dm-badge-warning">Warning</span>
                  <% else %>
                    <span class="px-2 py-0.5 text-[10px] font-semibold uppercase rounded-full dm-badge-info">Info</span>
                  <% end %>
                  <!-- Source badge -->
                  <span class="px-2 py-0.5 text-[10px] font-medium rounded-full dm-text-muted" style="background: var(--color-border-subtle);"><%= alert.alert_rule&.source %></span>
                </div>
                <p class="text-[13px] mt-1 flex items-center gap-2 dm-text-muted">
                  <span class="inline-flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                    <%= alert.current_value %>
                  </span>
                  <span class="inline-flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <%= time_ago_in_words(alert.started_at) %> ago
                  </span>
                  <% if alert.acknowledged %>
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium dm-badge-success">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                      Ack
                    </span>
                  <% end %>
                </p>
              </div>
            </div>
            <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" style="color: var(--color-icon-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="rounded-2xl px-8 py-16 text-center shadow-card dm-card">
      <div class="w-16 h-16 mx-auto mb-5 rounded-2xl flex items-center justify-center" style="background: var(--gradient-success);">
        <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h3 class="text-[18px] font-semibold mb-2 dm-text">All clear</h3>
      <p class="text-[14px] dm-text-muted">No alerts matching your filters.</p>
    </div>
  <% end %>

  <!-- Export Modal -->
  <div data-export-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" data-action="click->export#close"></div>
    <div class="relative rounded-2xl p-6 shadow-xl dm-card dm-border w-full max-w-md">
      <h3 class="text-[16px] font-semibold dm-text mb-4">Export Alerts</h3>
      <%= form_tag dashboard_project_exports_path(@project), method: :post do %>
        <div class="space-y-4">
          <div>
            <label class="block text-[12px] font-semibold uppercase tracking-wider dm-text-muted mb-1">Format</label>
            <select name="format_type" class="w-full px-3 py-2 rounded-lg text-[13px] dm-input dm-border">
              <option value="json">JSON</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-[12px] font-semibold uppercase tracking-wider dm-text-muted mb-1">From</label>
              <input type="date" name="since" class="w-full px-3 py-2 rounded-lg text-[13px] dm-input dm-border" />
            </div>
            <div>
              <label class="block text-[12px] font-semibold uppercase tracking-wider dm-text-muted mb-1">Until</label>
              <input type="date" name="until" class="w-full px-3 py-2 rounded-lg text-[13px] dm-input dm-border" />
            </div>
          </div>
          <% if params[:state].present? %>
            <input type="hidden" name="state" value="<%= params[:state] %>" />
          <% end %>
          <% if params[:severity].present? %>
            <input type="hidden" name="severity" value="<%= params[:severity] %>" />
          <% end %>
          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" data-action="export#close" class="px-4 py-2 rounded-lg text-[13px] font-medium dm-text-muted hover:dm-text transition-colors">Cancel</button>
            <button type="submit" data-action="export#submit" class="px-4 py-2 rounded-lg text-[13px] font-semibold text-white" style="background: var(--color-signal);">Download</button>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
